<!DOCTYPE html>
<html class="dark" lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Carrito de Compras - TechEase</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#0da6f2",
              "background-light": "#f5f7f8",
              "background-dark": "#101c22",
            },
            fontFamily: {
              display: ["Space Grotesk"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
      .material-symbols-outlined.filled {
        font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24;
      }
      @keyframes pop {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
      }
      .pop-animation {
        animation: pop 0.3s ease-out;
      }
    </style>
  </head>
  <body
    class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200"
  >
    <div
      class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden"
    >
      <div class="layout-container flex h-full grow flex-col">
        <div class="flex flex-1 justify-center">
          <div
            class="layout-content-container flex w-full flex-col max-w-6xl px-4 sm:px-6 lg:px-8"
          >
            <!-- CABECERA IDÉNTICA A INDEX.HTML (para consistencia) -->
            <header
              class="flex items-center justify-between whitespace-nowrap border-b border-gray-200 dark:border-white/10 py-4"
            >
              <div class="flex items-center gap-8">
                <a
                  class="flex items-center gap-2 text-gray-900 dark:text-white"
                  href="index.html"
                >
                  <span class="material-symbols-outlined text-primary text-2xl">
                    hub
                  </span>
                  <h2 class="text-xl font-bold">TechEase</h2>
                </a>
                <nav class="hidden md:flex items-center gap-6">
                  <a
                    class="text-sm font-medium hover:text-primary text-primary"
                    href="index.html"
                    >Productos</a
                  >
                  <a class="text-sm font-medium hover:text-primary" href="#"
                    >Ofertas</a
                  >
                  <a class="text-sm font-medium hover:text-primary" href="#"
                    >Novedades</a
                  >
                  <a class="text-sm font-medium hover:text-primary" href="#"
                    >Soporte</a
                  >
                </nav>
              </div>
              <div class="flex flex-1 items-center justify-end gap-4">
                <div class="hidden sm:flex items-center gap-2">
                  <button
                    class="flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-white/10"
                  >
                    <span class="material-symbols-outlined">person</span>
                  </button>
                  <button
                    id="favorites-button"
                    class="relative flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-white/10"
                  >
                    <span class="material-symbols-outlined">favorite</span>
                    <span
                      id="favorites-badge"
                      class="absolute top-1 right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-primary rounded-full"
                      style="display: none"
                      >0</span
                    >
                  </button>
                  <button
                    id="cart-button"
                    class="relative flex cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-white/10"
                  >
                    <span class="material-symbols-outlined">shopping_cart</span>
                    <span
                      id="cart-badge"
                      class="absolute top-1 right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-primary rounded-full"
                      style="display: none"
                      >0</span
                    >
                  </button>
                </div>
                <button
                  id="mobile-menu-toggle"
                  class="flex md:hidden cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 w-10 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-white/10"
                >
                  <span class="material-symbols-outlined">menu</span>
                </button>
              </div>
            </header>

            <!-- Menú Móvil (Oculto por defecto) -->
            <div
              id="mobile-menu"
              class="hidden md:hidden bg-background-light dark:bg-background-dark border-b border-gray-200 dark:border-white/10"
            >
              <nav class="flex flex-col p-4 space-y-2">
                <a
                  href="index.html"
                  class="font-medium hover:text-primary text-primary"
                  >Productos</a
                >
                <a href="#" class="font-medium hover:text-primary">Ofertas</a>
                <a href="#" class="font-medium hover:text-primary">Novedades</a>
                <a href="#" class="font-medium hover:text-primary">Soporte</a>
                <div class="flex items-center gap-2 border-t border-gray-200 dark:border-white/10 pt-4 mt-2">
                  <button id="mobile-favorites-button" class="relative flex-1 flex items-center justify-center gap-2 h-10 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-white/10">
                    <span class="material-symbols-outlined">favorite</span>
                    <span>Favoritos</span>
                     <span
                      id="mobile-favorites-badge"
                      class="absolute top-1 right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-primary rounded-full"
                      style="display: none"
                      >0</span
                    >
                  </button>
                  <button id="mobile-cart-button" class="relative flex-1 flex items-center justify-center gap-2 h-10 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-white/10">
                    <span class="material-symbols-outlined">shopping_cart</span>
                    <span>Carrito</span>
                     <span
                      id="mobile-cart-badge"
                      class="absolute top-1 right-1 flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-primary rounded-full"
                      style="display: none"
                      >0</span
                    >
                  </button>
                </div>
              </nav>
            </div>
            <!-- FIN DE CABECERA -->
            
            <main class="w-full max-w-7xl mx-auto px-0 py-8 md:py-12">
              <div class="flex flex-wrap gap-2 mb-6">
                <a
                  class="text-gray-500 dark:text-[#9cb0ba] text-sm font-medium leading-normal hover:text-primary"
                  href="index.html"
                  >Inicio</a
                >
                <span
                  class="text-gray-500 dark:text-[#9cb0ba] text-sm font-medium leading-normal"
                  >/</span
                >
                <span
                  class="text-gray-900 dark:text-white text-sm font-medium leading-normal"
                  >Carrito</span
                >
              </div>
              <div class="flex flex-wrap justify-between items-baseline gap-4 mb-8">
                <h1
                  class="text-gray-900 dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]"
                >
                  Mi Carrito
                </h1>
                <a
                  class="text-primary text-sm font-medium leading-normal hover:underline"
                  href="index.html"
                  >Seguir Comprando</a
                >
              </div>
              <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 xl:gap-12">
                <div class="lg:col-span-2">
                  <!-- Contenedor de items del carrito (se llenará con JS) -->
                  <div id="checkout-items-container" class="flex flex-col gap-px overflow-hidden rounded-xl border border-gray-200 dark:border-[#283339] bg-gray-200 dark:bg-[#283339]">
                    <!-- Los items se insertarán aquí -->
                  </div>
                  <!-- Mensaje de carrito vacío -->
                  <div id="checkout-empty-message" class="hidden text-center py-16 bg-background-light dark:bg-background-dark rounded-xl border border-gray-200 dark:border-[#283339]">
                      <span class="material-symbols-outlined text-8xl mb-4 text-gray-400">shopping_cart_off</span>
                      <p class="text-2xl font-bold text-gray-900 dark:text-white">Tu carrito está vacío</p>
                      <p class="text-gray-500 dark:text-gray-400">Añade productos para verlos aquí.</p>
                  </div>
                </div>
                <div class="lg:col-span-1">
                  <div class="sticky top-28 space-y-6">
                    <div
                      class="rounded-xl border border-gray-200 dark:border-[#283339] bg-background-light dark:bg-background-dark p-6 shadow-sm"
                    >
                      <h2 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">
                        Resumen del Pedido
                      </h2>
                      <div class="space-y-3">
                        <div class="flex justify-between text-sm text-gray-600 dark:text-[#9cb0ba]">
                          <span>Subtotal</span>
                          <span id="checkout-subtotal">S/ 0.00</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600 dark:text-[#9cb0ba]">
                          <span>Envío</span>
                          <span>Gratis</span>
                        </div>
                        <div class="flex justify-between text-sm text-gray-600 dark:text-[#9cb0ba]">
                          <span>Impuestos (8%)</span>
                          <span id="checkout-tax">S/ 0.00</span>
                        </div>
                        <div
                          class="border-t border-gray-200 dark:border-[#283339] my-3"
                        ></div>
                        <div class="flex justify-between text-lg font-bold text-gray-900 dark:text-white">
                          <span>Total</span>
                          <span id="checkout-total">S/ 0.00</span>
                        </div>
                      </div>
                    </div>
                    <div class="flex flex-col gap-4">
                      <button
                        class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-lg h-12 bg-primary text-white gap-2 text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors shadow"
                      >
                        Finalizar Compra
                      </button>
                      <div class="flex justify-center items-center gap-4 py-2">
                        <img
                          class="h-5 grayscale opacity-60"
                          data-alt="Visa Logo"
                          src="https://lh3.googleusercontent.com/aida-public/AB6AXuAIBEtqXg4MO1qJ8gX17tJcYKn6SQY8Pftq_W4cHOLiWx3YkkM7AEhBlKUViLgHGwAgO5AlPugD0MPEz3BkUBoL-zqPp7Ab22BsDIMuGizx0WNu-ta0sWUq1XROJtU_6sBq8w2A8x4Rdqdgg91DJ3JKjOC_EERyRTP7mJr-_CTspNJlHR13oHFL-j93f0yTKPqcZbw7kAat36Tq-ZBG_-aKYBzX1V-1dWrvalQNVxI8SV6LLtj2Hd1d8JQUblvBOVteVY88feMzYuQE"
                        />
                        <img
                          class="h-5 grayscale opacity-60"
                          data-alt="Mastercard Logo"
                          src="https://lh3.googleusercontent.com/aida-public/AB6AXuBRqCop0wMS3zcu6Hz4AKrR2WQxQX2q0XLqDoyXttuObTMcupqGy9ElO3hOR3KIAgY4hFGzTD0jPZelUugFGZ1Ldv10iwjjIVIPXVP5kNubk7C-vQO2UV-VCd-0CdZGUccKQguEDS1o7oD8WQMz8OzaCPk5SigyBnSJ0ChKq9uEqC_mIkRNgEJ47oFD-Qb-i8tsg-MpAPrw8_FBa0tY6k_hwHHdgQtFavjYQW-noscf_QD9gAO41l0_BzRYRQJAQ2biZQg_B_G_DYpo"
                        />
                        <img
                          class="h-5 grayscale opacity-60"
                          data-alt="PayPal Logo"
                          src="https://lh3.googleusercontent.com/aida-public/AB6AXuDSM1PFpr4pMUhmlvq_pG9M9QabpjE7jBleCyKz56mzjuLbMsnHrD1d2_ltcHSEow3Y1pYXs7XAVGn2mbSHraAxtS19oqRuthutC4jufzv1xy0BTOKVkpPiri9U7xV3VX6HA0fMkt_loH_TOYwRmK4cPt0ghl-t5X-jlqcOWmSa9xA8GqPvUMrsv9k2zGqqsnCkozUtXx4XE9gRix5L-BZHl828-jt-qwZ2iMRmd2I8DvB64f7L-2oghc94ZBYHaWh0NR-wKrxn94F1"
                        />
                        <img
                          class="h-5 grayscale opacity-60"
                          data-alt="American Express Logo"
                          src="https://lh3.googleusercontent.com/aida-public/AB6AXuAq0yq5V2iHIlmv_RG_Pss7CG2mtw1BVIK-fl3XlwuXrfeQ4Pc7M9sqiIXEO6ltUJVC89ChNAhqvpq2kn62UcRylscaRQBKePLH9idUAz1zLG7fAAWjpo_ZUlzTN8B-V_GBMpuOOOM8rG8yXdsoh29PTBTmKm3IcBV6R1rkc81G9xXMJkAnA_YaeUmPVORscw3Ajwagu8K27WD4nN7wdXFPIjUE6mVmrejjRpZSaFvejVlbR5isniLjpQCtsc8Vllk-4KoaIPCnRvYS"
                        />
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </main>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALES IDÉNTICOS A INDEX.HTML -->
    <div
      id="cart-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
      style="display: none"
    >
      <div
        class="bg-background-light dark:bg-background-dark w-full max-w-md rounded-xl shadow-2xl m-4"
      >
        <div
          class="flex items-center justify-between border-b border-gray-200 dark:border-white/10 p-4"
        >
          <h3 class="text-lg font-bold text-gray-900 dark:text-white">
            Tu Carrito
          </h3>
          <button
            id="close-cart-modal"
            class="text-gray-500 hover:text-primary"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div id="cart-modal-body" class="p-6 max-h-[60vh] overflow-y-auto">
          <!-- Items del carrito se insertarán aquí -->
        </div>
        <div
          class="border-t border-gray-200 dark:border-white/10 p-4 bg-gray-50 dark:bg-white/5 rounded-b-xl"
        >
          <div class="flex justify-between items-center mb-4">
            <span class="text-lg font-medium text-gray-800 dark:text-gray-200"
              >Total:</span
            >
            <span
              id="cart-total"
              class="text-xl font-bold text-gray-900 dark:text-white"
              >S/ 0.00</span
            >
          </div>
          <!-- MODIFICADO: De <button> a <a> para enlazar -->
          <a
            href="checkout.html"
            class="w-full h-12 rounded-lg bg-primary text-white font-bold hover:bg-primary/90 transition flex items-center justify-center"
          >
            Ir a Pagar
          </a>
        </div>
      </div>
    </div>

    <div
      id="favorites-modal"
      class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
      style="display: none"
    >
      <div
        class="bg-background-light dark:bg-background-dark w-full max-w-md rounded-xl shadow-2xl m-4"
      >
        <div
          class="flex items-center justify-between border-b border-gray-200 dark:border-white/10 p-4"
        >
          <h3 class="text-lg font-bold text-gray-900 dark:text-white">
            Tus Favoritos
          </h3>
          <button
            id="close-favorites-modal"
            class="text-gray-500 hover:text-primary"
          >
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>
        <div id="favorites-modal-body" class="p-6 max-h-[60vh] overflow-y-auto">
          <!-- Items favoritos se insertarán aquí -->
        </div>
      </div>
    </div>
    <!-- FIN DE MODALES -->

    <!-- Plantilla de Script -->
    <script type="module">
      // --- DATABASE (IDÉNTICA A INDEX.HTML) ---
      const allProducts = [
        { id: 1, name: "Audífonos WH-1000XM5", category: "Audifonos", brand: "Sony", price: 1499.90, img: "https://placehold.co/600x600/101c22/f5f7f8?text=WH-1000XM5", alt: "Audífonos Sony WH-1000XM5 con cancelación de ruido." },
        { id: 2, name: "AirPods Pro 2da Gen", category: "Audifonos", brand: "Apple", price: 1099.00, img: "https://placehold.co/600x600/101c22/f5f7f8?text=AirPods+Pro+2", alt: "Audífonos inalámbricos Apple AirPods Pro 2." },
        { id: 3, name: "Audífonos QuietComfort Ultra", category: "Audifonos", brand: "Bose", price: 1799.00, img: "https://placehold.co/600x600/101c22/f5f7f8?text=Bose+QC+Ultra", alt: "Audífonos Bose QuietComfort Ultra con audio inmersivo." },
        { id: 4, name: "Parlante Bluetooth Charge 5", category: "Parlantes", brand: "JBL", price: 649.00, img: "https://placehold.co/600x600/101c22/f5f7f8?text=JBL+Charge+5", alt: "Parlante portátil JBL Charge 5 resistente al agua." },
        { id: 5, name: "Parlante SoundLink Flex", category: "Parlantes", brand: "Bose", price: 799.00, img: "https://placehold.co/600x600/101c22/f5f7f8?text=Bose+Flex", alt: "Parlante Bose SoundLink Flex, robusto y portátil." },
        { id: 6, name: "Parlante inteligente Echo Dot 5", category: "Parlantes", brand: "Amazon", price: 229.00, img: "https://placehold.co/600x600/101c22/f5f7f8?text=Echo+Dot+5", alt: "Parlante inteligente Amazon Echo Dot 5ta generación con Alexa." },
        { id: 7, name: "Cargador Anker 735 GaNPrime 65W", category: "Cargadores", brand: "Anker", price: 219.00, img: "https://placehold.co/600x600/101c22/f5f7f8?text=Anker+65W", alt: "Cargador rápido Anker 735 GaNPrime 65W, 3 puertos." },
        { id: 8, name: "Cargador USB-C 20W", category: "Cargadores", brand: "Apple", price: 129.00, img: "https://placehold.co/600x600/101c22/f5f7f8?text=Apple+20W", alt: "Cargador Apple USB-C original de 20W." },
        { id: 9, name: "Cargador Inalámbrico 3-en-1", category: "Cargadores", brand: "Belkin", price: 499.00, img: "https://placehold.co/600x600/101c22/f5f7f8?text=Belkin+3-en-1", alt: "Estación de carga inalámbrica Belkin 3-en-1 MagSafe." },
      ];

      // --- STATE (IDÉNTICO A INDEX.HTML) ---
      let cart = JSON.parse(localStorage.getItem('techEaseCart')) || [];
      let favorites = JSON.parse(localStorage.getItem('techEaseFavorites')) || [];

      // --- DOM SELECTORS (Comunes) ---
      const cartButton = document.getElementById("cart-button");
      const cartBadge = document.getElementById("cart-badge");
      const cartModal = document.getElementById("cart-modal");
      const closeCartModalButton = document.getElementById("close-cart-modal");
      const cartModalBody = document.getElementById("cart-modal-body");
      const cartTotalElement = document.getElementById("cart-total");
      const mobileCartButton = document.getElementById("mobile-cart-button");
      const mobileCartBadge = document.getElementById("mobile-cart-badge");

      const favoritesButton = document.getElementById("favorites-button");
      const favoritesBadge = document.getElementById("favorites-badge");
      const favoritesModal = document.getElementById("favorites-modal");
      const closeFavoritesModalButton = document.getElementById("close-favorites-modal");
      const favoritesModalBody = document.getElementById("favorites-modal-body");
      const mobileFavoritesButton = document.getElementById("mobile-favorites-button");
      const mobileFavoritesBadge = document.getElementById("mobile-favorites-badge");
      
      const mobileMenuToggle = document.getElementById("mobile-menu-toggle");
      const mobileMenu = document.getElementById("mobile-menu");
      const mobileMenuIcon = mobileMenuToggle.querySelector("span");
      
      // --- (NUEVO) DOM SELECTORS (Checkout) ---
      const checkoutItemsContainer = document.getElementById('checkout-items-container');
      const checkoutEmptyMessage = document.getElementById('checkout-empty-message');
      const checkoutSubtotal = document.getElementById('checkout-subtotal');
      const checkoutTax = document.getElementById('checkout-tax');
      const checkoutTotal = document.getElementById('checkout-total');
      const orderSummaryContainer = document.querySelector('.lg\\:col-span-1 .sticky');


      // --- FUNCIONES DE PERSISTENCIA ---
      function saveCart() {
        localStorage.setItem('techEaseCart', JSON.stringify(cart));
      }
      function saveFavorites() {
        localStorage.setItem('techEaseFavorites', JSON.stringify(favorites));
      }

      // --- RENDER FUNCTIONS (Comunes) ---
      function renderCartModal() {
        cartModalBody.innerHTML = "";
        let total = 0;
        if (cart.length === 0) {
          cartModalBody.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Tu carrito está vacío.</p>';
          cartTotalElement.textContent = `S/ 0.00`;
          return;
        }
        
        const cartItems = cart.reduce((acc, product) => {
          acc[product.id] = acc[product.id] || { ...product, quantity: 0 };
          acc[product.id].quantity += 1;
          return acc;
        }, {});

        Object.values(cartItems).forEach((item) => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          const cartItemHTML = `
            <div class="flex items-center gap-4 mb-4">
              <img src="${item.img}" alt="${item.alt}" class="w-16 h-16 object-cover rounded-lg">
              <div class="flex-1">
                <p class="font-medium text-gray-900 dark:text-white">${item.name}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">S/ ${item.price.toFixed(2)} x ${item.quantity}</p>
              </div>
              <div class="text-right">
                  <p class="font-bold text-gray-900 dark:text-white">S/ ${itemTotal.toFixed(2)}</p>
                  <button data-product-id="${item.id}" class="remove-from-cart-btn text-sm text-red-500 hover:underline">Quitar</button>
              </div>
            </div>`;
          cartModalBody.insertAdjacentHTML("beforeend", cartItemHTML);
        });
        cartTotalElement.textContent = `S/ ${total.toFixed(2)}`;
      }

      function renderFavoritesModal() {
        favoritesModalBody.innerHTML = "";
        if (favorites.length === 0) {
          favoritesModalBody.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">No tienes productos favoritos.</p>';
          return;
        }
        
        const uniqueFavoriteIds = [...new Set(favorites)];
        const favoriteProducts = allProducts.filter((p) => uniqueFavoriteIds.includes(p.id));

        favoriteProducts.forEach((item) => {
          const favItemHTML = `
            <div class="flex items-center gap-4 mb-4">
              <img src="${item.img}" alt="${item.alt}" class="w-16 h-16 object-cover rounded-lg">
              <div class="flex-1">
                <p class="font-medium text-gray-900 dark:text-white">${item.name}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400">${item.brand}</p>
                <p class="font-bold text-primary">S/ ${item.price.toFixed(2)}</p>
              </div>
              <div class="text-right">
                  <a href="product-detail.html?id=${item.id}" class="text-sm text-primary hover:underline">Ver</a>
              </div>
            </div>`;
          favoritesModalBody.insertAdjacentHTML("beforeend", favItemHTML);
        });
      }

      // --- EVENT HANDLERS & LOGIC (Comunes) ---
      function updateCartBadge() {
        const count = cart.length;
        const badges = [cartBadge, mobileCartBadge];
        badges.forEach(badge => {
          if (count === 0) {
            badge.style.display = "none";
          } else {
            badge.style.display = "flex";
            badge.textContent = count;
            badge.classList.add("pop-animation");
            badge.onanimationend = () => badge.classList.remove("pop-animation");
          }
        });
      }

      function updateFavoritesBadge() {
        const uniqueFavorites = [...new Set(favorites)];
        const count = uniqueFavorites.length;
        const badges = [favoritesBadge, mobileFavoritesBadge];
        badges.forEach(badge => {
          if (count === 0) {
            badge.style.display = "none";
          } else {
            badge.style.display = "flex";
            badge.textContent = count;
            badge.classList.add("pop-animation");
            badge.onanimationend = () => badge.classList.remove("pop-animation");
          }
        });
      }

      function handleCartModalClick(event) {
        const button = event.target.closest("button");
        if (!button || !button.classList.contains("remove-from-cart-btn")) return;

        const productId = parseInt(button.dataset.productId);
        const productIndex = cart.findIndex((p) => p.id === productId);
        if (productIndex > -1) {
          cart.splice(productIndex, 1);
        }
        saveCart();
        renderCartModal();
        updateCartBadge();
        renderCheckoutPage(); // (NUEVO) Actualizar la página de checkout si estamos en ella
      }

      function openCartModal() {
        renderCartModal();
        cartModal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeCartModal() {
        cartModal.style.display = "none";
        document.body.style.overflow = "auto";
      }

      function openFavoritesModal() {
        renderFavoritesModal();
        favoritesModal.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeFavoritesModal() {
        favoritesModal.style.display = "none";
        document.body.style.overflow = "auto";
      }

      function toggleMobileMenu() {
        const isHidden = mobileMenu.classList.toggle("hidden");
        mobileMenuIcon.textContent = isHidden ? "menu" : "close";
      }
      
      // --- (NUEVO) LÓGICA DE LA PÁGINA DE CHECKOUT ---

      /**
       * Renderiza la lista de items y los totales en la página de checkout.
       */
      function renderCheckoutPage() {
        if (!checkoutItemsContainer) return; // Solo ejecutar en la página de checkout

        checkoutItemsContainer.innerHTML = "";
        let subtotal = 0;

        const cartItems = cart.reduce((acc, product) => {
          acc[product.id] = acc[product.id] || { ...product, quantity: 0 };
          acc[product.id].quantity += 1;
          return acc;
        }, {});

        const itemKeys = Object.keys(cartItems);

        if (itemKeys.length === 0) {
          checkoutEmptyMessage.classList.remove("hidden");
          if (orderSummaryContainer) orderSummaryContainer.classList.add("hidden");
        } else {
          checkoutEmptyMessage.classList.add("hidden");
          if (orderSummaryContainer) orderSummaryContainer.classList.remove("hidden");

          itemKeys.forEach(key => {
            const item = cartItems[key];
            const itemTotal = item.price * item.quantity;
            subtotal += itemTotal;

            const itemHTML = `
            <div class="flex flex-col sm:flex-row gap-4 bg-background-light dark:bg-background-dark px-4 py-4 justify-between items-start">
              <div class="flex items-start gap-4 w-full">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg h-24 w-24 flex-shrink-0" style='background-image: url("${item.img}");'></div>
                <div class="flex flex-1 flex-col justify-center gap-1">
                  <p class="text-gray-900 dark:text-white text-base font-medium leading-normal">${item.name}</p>
                  <p class="text-gray-500 dark:text-[#9cb0ba] text-sm font-normal leading-normal">Precio Unitario: S/ ${item.price.toFixed(2)}</p>
                  <p class="text-gray-700 dark:text-gray-300 text-sm font-medium leading-normal sm:hidden">Subtotal: S/ ${itemTotal.toFixed(2)}</p>
                </div>
              </div>
              <div class="flex sm:flex-col justify-between items-end w-full sm:w-auto gap-4 pl-0 sm:pl-4">
                <div class="flex items-center gap-2 text-gray-900 dark:text-white">
                  <button data-action="decrease" data-product-id="${item.id}" class="text-lg font-medium leading-normal flex h-7 w-7 items-center justify-center rounded-full bg-gray-200 dark:bg-[#283339] cursor-pointer hover:bg-gray-300 dark:hover:bg-[#3a4750] transition-colors">-</button>
                  <input class="text-base font-medium leading-normal w-6 p-0 text-center bg-transparent focus:outline-0 focus:ring-0 focus:border-none border-none [appearance:textfield] [&amp;::-webkit-inner-spin-button]:appearance-none [&amp;::-webkit-outer-spin-button]:appearance-none" type="number" value="${item.quantity}" readonly />
                  <button data-action="increase" data-product-id="${item.id}" class="text-lg font-medium leading-normal flex h-7 w-7 items-center justify-center rounded-full bg-gray-200 dark:bg-[#283339] cursor-pointer hover:bg-gray-300 dark:hover:bg-[#3a4750] transition-colors">+</button>
                </div>
                <div class="flex items-center gap-4">
                  <p class="text-gray-800 dark:text-white text-base font-medium leading-normal hidden sm:block">S/ ${itemTotal.toFixed(2)}</p>
                  <button data-action="delete" data-product-id="${item.id}" class="text-red-500 hover:text-red-700 dark:text-red-500 dark:hover:text-red-400 transition-colors">
                    <span class="material-symbols-outlined">delete</span>
                  </button>
                </div>
              </div>
            </div>`;
            checkoutItemsContainer.insertAdjacentHTML("beforeend", itemHTML);
          });
        }
        
        // Calcular y mostrar totales
        const tax = subtotal * 0.08; // 8% como en el ejemplo
        const total = subtotal + tax;

        checkoutSubtotal.textContent = `S/ ${subtotal.toFixed(2)}`;
        checkoutTax.textContent = `S/ ${tax.toFixed(2)}`;
        checkoutTotal.textContent = `S/ ${total.toFixed(2)}`;
      }

      /**
       * Maneja los clics en los botones de la página de checkout (delegación).
       */
      function handleCheckoutInteraction(event) {
        const button = event.target.closest("button");
        if (!button) return;

        const action = button.dataset.action;
        const productId = parseInt(button.dataset.productId);
        if (!action || !productId) return;

        const product = allProducts.find(p => p.id === productId);
        if (!product) return;

        if (action === 'increase') {
          cart.push(product);
        } else if (action === 'decrease') {
          const productIndex = cart.findIndex((p) => p.id === productId);
          if (productIndex > -1) {
            cart.splice(productIndex, 1);
          }
        } else if (action === 'delete') {
          cart = cart.filter(p => p.id !== productId);
        }

        saveCart();
        renderCheckoutPage();
        updateCartBadge();
        renderCartModal(); // Sincronizar el modal también
      }

      // --- INITIALIZATION ---
      document.addEventListener("DOMContentLoaded", () => {
        // --- Lógica de esta página ---
        renderCheckoutPage(); // Renderizar la página de checkout
        if(checkoutItemsContainer) {
          checkoutItemsContainer.addEventListener('click', handleCheckoutInteraction);
        }

        // --- Listeners comunes (modales, menú, etc.) ---
        cartButton.addEventListener("click", openCartModal);
        favoritesButton.addEventListener("click", openFavoritesModal);
        mobileCartButton.addEventListener("click", openCartModal);
        mobileFavoritesButton.addEventListener("click", openFavoritesModal);
        closeCartModalButton.addEventListener("click", closeCartModal);
        closeFavoritesModalButton.addEventListener("click", closeFavoritesModal);
        
        cartModal.addEventListener("click", (event) => {
          if (event.target === cartModal) closeCartModal();
        });
        favoritesModal.addEventListener("click", (event) => {
          if (event.target === favoritesModal) closeFavoritesModal();
        });
        cartModalBody.addEventListener("click", handleCartModalClick);
        mobileMenuToggle.addEventListener("click", toggleMobileMenu);

        // Cargar estado inicial de los badges
        updateCartBadge();
        updateFavoritesBadge();
      });
    </script>
  </body>
</html>