<!DOCTYPE html>
<html class="dark" lang="es">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>TechEase | Tu tienda virtual</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com" rel="preconnect" />
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&amp;display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#0da6f2",
              "background-light": "#f5f7f8",
              "background-dark": "#101c22",
            },
            fontFamily: {
              display: ["Space Grotesk"],
            },
            borderRadius: {
              DEFAULT: "0.25rem",
              lg: "0.5rem",
              xl: "0.75rem",
              full: "9999px",
            },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
      .material-symbols-outlined.filled {
        font-variation-settings: "FILL" 1, "wght" 400, "GRAD" 0, "opsz" 24;
      }
      @keyframes pop {
        0% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.3);
        }
        100% {
          transform: scale(1);
        }
      }
      .pop-animation {
        animation: pop 0.3s ease-out;
      }
      .category-button {
        display: flex;
        height: 2.5rem;
        flex-shrink: 0;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        column-gap: 0.5rem;
        border-radius: 9999px;
        background-color: #e5e7eb;
        padding-left: 1rem;
        padding-right: 1rem;
        transition: background-color 0.2s, color 0.2s;
      }
      .category-button:hover {
        background-color: #d1d5db;
      }
      .dark .category-button {
        background-color: rgba(255, 255, 255, 0.1);
      }
      .dark .category-button:hover {
        background-color: rgba(255, 255, 255, 0.2);
      }
      .category-button.active {
        background-color: #0da6f2;
        color: white;
      }
      .dark .category-button.active {
        background-color: #0da6f2;
        color: white;
      }
    </style>
  </head>

  <body
    class="bg-background-light dark:bg-background-dark font-display text-gray-800 dark:text-gray-200"
  >
    <div
      class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden"
    >
      <div class="layout-container flex h-full grow flex-col">
        <div class="flex flex-1 justify-center">
          <div
            class="layout-content-container flex w-full flex-col max-w-6xl px-4 sm:px-6 lg:px-8"
          >
            <div id="header-placeholder"></div>

            <main class="py-10">
              <section class="mb-12 text-center">
                <h1
                  class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4"
                >
                  La Tecnología que te Mueve
                </h1>
                <p
                  class="text-lg text-gray-500 dark:text-gray-400 max-w-2xl mx-auto mb-8"
                >
                  Explora los productos más populares y las últimas novedades en
                  tecnología.
                </p>
                <div class="max-w-2xl mx-auto">
                  <label class="flex flex-col">
                    <div
                      class="relative flex w-full flex-1 items-stretch rounded-full h-14 bg-white dark:bg-white/5 border border-gray-200 dark:border-white/10 focus-within:ring-2 focus-within:ring-primary shadow-sm"
                    >
                      <div
                        class="text-gray-400 dark:text-gray-500 flex items-center justify-center pl-5 pr-2"
                      >
                        <span class="material-symbols-outlined">search</span>
                      </div>
                      <input
                        id="search-input"
                        name="search"
                        class="form-input w-full flex-1 resize-none overflow-hidden rounded-full text-gray-900 dark:text-white focus:outline-0 focus:ring-0 border-none bg-transparent h-full placeholder:text-gray-400 dark:placeholder:text-gray-500 text-base font-normal"
                        placeholder="Busca productos, marcas y más..."
                        value=""
                      />
                    </div>
                  </label>
                </div>
              </section>

              <section class="mb-12">
                <div
                  id="category-buttons"
                  class="flex gap-3 overflow-x-auto [-ms-scrollbar-style:none] [scrollbar-width:none] [&::-webkit-scrollbar]:hidden pb-2"
                ></div>
              </section>

              <div class="flex items-center justify-between pb-4 pt-5">
                <h2
                  id="product-grid-title"
                  class="text-gray-900 dark:text-white text-2xl font-bold leading-tight tracking-tighter"
                >
                  Nuestros Productos
                </h2>
              </div>

              <div
                id="product-grid"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"
              ></div>

              <div
                id="no-results"
                class="hidden text-center text-gray-500 dark:text-gray-400 py-24"
              >
                <span class="material-symbols-outlined text-8xl mb-4">
                  manage_search
                </span>
                <p class="text-2xl font-bold">No se encontraron productos</p>
                <p>Intenta ajustar tu búsqueda o filtros.</p>
              </div>
            </main>

            <div id="footer-placeholder"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="modals-placeholder"></div>

    <script type="module">
      import { loadLayout } from "./js/loader.js";
      await loadLayout();

      import {
        initializeApp,
        allProducts,
        cart,
        favorites,
        saveCart,
        saveFavorites,
        updateCartBadge,
        updateFavoritesBadge,
        getProductQuantityInCart,
        removeSingleInstanceFromCart,
        removeAllOfProductFromCart
      } from "./js/app.js";

      initializeApp();

      const productGrid = document.getElementById("product-grid");
      const noResultsMessage = document.getElementById("no-results");
      const categoryButtonsContainer =
        document.getElementById("category-buttons");
      const searchInput = document.getElementById("search-input");
      const productGridTitle = document.getElementById("product-grid-title");

      let selectedCategory = "Todos";
      let searchTerm = "";

      function renderCategories() {
        if (!categoryButtonsContainer) return;

        const categories = [...new Set(allProducts.map((p) => p.category))];
        categoryButtonsContainer.innerHTML = "";

        const allButton = document.createElement("button");
        allButton.dataset.category = "Todos";
        allButton.className = "category-button active";
        allButton.innerHTML = `<p class="text-sm font-medium">Todos</p>`;
        categoryButtonsContainer.appendChild(allButton);

        categories.forEach((category) => {
          const categoryBtn = document.createElement("button");
          categoryBtn.dataset.category = category;
          categoryBtn.className = "category-button";
          categoryBtn.innerHTML = `<p class="text-sm font-medium">${category}</p>`;
          categoryButtonsContainer.appendChild(categoryBtn);
        });

        const section = categoryButtonsContainer.closest("section");
        if (section) section.style.display = "block";
      }

      function renderProducts() {
        productGrid.innerHTML = "";

        let productsToRender = allProducts;
        if (selectedCategory !== "Todos") {
          productsToRender = allProducts.filter(
            (p) => p.category === selectedCategory
          );
        }

        if (searchTerm) {
          const lowerSearchTerm = searchTerm.toLowerCase();
          productsToRender = productsToRender.filter(
            (p) =>
              p.name.toLowerCase().includes(lowerSearchTerm) ||
              p.brand.toLowerCase().includes(lowerSearchTerm)
          );
        }

        productGridTitle.textContent = searchTerm
          ? `Resultados para "${searchTerm}"`
          : selectedCategory === "Todos"
          ? "Nuestros Productos"
          : selectedCategory;

        if (productsToRender.length === 0) {
          noResultsMessage.style.display = "block";
        } else {
          noResultsMessage.style.display = "none";
        }

        productsToRender.forEach((product) => {
          const isFavorite = favorites.includes(product.id);
          const quantityInCart = getProductQuantityInCart(product.id);

          let actionsHtml = '';
          if (quantityInCart === 0) {
            actionsHtml = `
              <button data-product-id="${product.id}" class="add-to-cart-btn mt-3 w-full h-10 rounded-lg bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary font-bold hover:bg-primary hover:text-white dark:hover:bg-primary dark:hover:text-white transition border border-primary/20">
                Añadir al Carrito
              </button>
            `;
          } else {
            actionsHtml = `
              <div class="mt-3 flex items-center justify-between gap-3">
                <div class="flex items-center border border-gray-300 dark:border-gray-700 rounded-lg h-10">
                  <button data-product-id="${product.id}" data-action="decrease" class="quantity-change-btn px-3 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-l-lg transition-colors">
                    -
                  </button>
                  <span class="w-10 text-center text-sm font-bold bg-transparent border-x border-gray-300 dark:border-gray-700">${quantityInCart}</span>
                  <button data-product-id="${product.id}" data-action="increase" class="quantity-change-btn px-3 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-r-lg transition-colors">
                    +
                  </button>
                </div>
                <button data-product-id="${product.id}" data-action="remove-all" title="Eliminar producto" class="remove-all-btn flex-1 flex items-center justify-center gap-2 h-10 px-3 rounded-lg text-white font-bold bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 transition-colors">
                  <span class="material-symbols-outlined text-lg">delete</span>
                  <span class="text-sm">Eliminar</span>
                </button>
              </div>
            `;
          }
          
          const productCard = `
          <div class="flex flex-col gap-3 group">
            <div class="relative w-full bg-center bg-no-repeat aspect-square bg-cover rounded-xl bg-gray-200 dark:bg-white/5 overflow-hidden">
              <a href="product-detail.html?id=${product.id}">
                <img alt="${product.alt}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" src="${product.img}" />
              </a>
              <button data-product-id="${product.id}" class="favorite-btn absolute top-3 right-3 flex items-center justify-center h-8 w-8 rounded-full bg-white/50 dark:bg-black/50 backdrop-blur-sm text-gray-800 dark:text-white hover:bg-white dark:hover:bg-black transition">
                <span class="material-symbols-outlined text-lg ${isFavorite ? "filled text-red-500" : ""}">favorite</span>
              </button>
            </div>
            <div>
              <p class="text-gray-500 dark:text-gray-400 text-sm font-normal leading-normal">${product.brand}</p>
              <a href="product-detail.html?id=${product.id}" class="hover:underline">
                <p class="text-gray-900 dark:text-white text-base font-medium leading-normal truncate">${product.name}</p>
              </a>
              <p class="text-gray-800 dark:text-gray-200 text-base font-bold leading-normal mt-1">S/ ${product.price.toFixed(2)}</p>
              
              <div class="product-actions">
                ${actionsHtml}
              </div>

            </div>
          </div>
        `;
          productGrid.insertAdjacentHTML("beforeend", productCard);
        });
      }

      function handleProductGridClick(event) {
        const button = event.target.closest("button");
        if (!button) return;

        const productIdStr = button.dataset.productId;
        if (!productIdStr) return;
        
        const productId = parseInt(productIdStr);
        const product = allProducts.find((p) => p.id === productId);

        let cartChanged = false;

        if (button.classList.contains("favorite-btn")) {
          const icon = button.querySelector("span");
          if (favorites.includes(productId)) {
            favorites = favorites.filter((favId) => favId !== productId);
            icon.classList.remove("filled", "text-red-500");
          } else {
            favorites.push(productId);
            icon.classList.add("filled", "text-red-500");
          }
          saveFavorites();
          updateFavoritesBadge();
          return; 
        }

        if (!product) return;

        if (button.classList.contains("add-to-cart-btn")) {
          cart.push(product);
          cartChanged = true;
        }

        if (button.classList.contains("quantity-change-btn")) {
          const action = button.dataset.action;
          if (action === 'increase') {
            cart.push(product);
            cartChanged = true;
          } else if (action === 'decrease') {
            cartChanged = removeSingleInstanceFromCart(productId);
          }
        }
        
        if (button.classList.contains("remove-all-btn")) {
          cartChanged = removeAllOfProductFromCart(productId);
        }

        if (cartChanged) {
          saveCart();
          updateCartBadge();
          renderProducts(); 
        }
      }

      function handleCategoryClick(event) {
        const button = event.target.closest(".category-button");
        if (!button) return;

        selectedCategory = button.dataset.category;

        categoryButtonsContainer
          .querySelectorAll(".category-button")
          .forEach((btn) => {
            btn.classList.remove("active");
          });
        button.classList.add("active");

        renderProducts();
      }

      function handleSearchInput(event) {
        searchTerm = event.target.value;
        renderProducts();
      }
      
      renderCategories();
      renderProducts();

      productGrid.addEventListener("click", handleProductGridClick);
      categoryButtonsContainer.addEventListener("click", handleCategoryClick);
      searchInput.addEventListener("input", handleSearchInput);

    </script>
  </body>
</html>